<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
      <link rel="shortcut icon" href="../img/favicon.ico" />
    <title>Rationale - Mosaic</title>
    <link rel="stylesheet" href="../css/theme.css" />
    <link rel="stylesheet" href="../css/theme_extra.css" />
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/styles/github.min.css" />
        <link href="../style.css" rel="stylesheet" />
    
      <script>
        // Current page data
        var mkdocs_page_name = "Rationale";
        var mkdocs_page_input_path = "rationale.md";
        var mkdocs_page_url = null;
      </script>
    
    <!--[if lt IE 9]>
      <script src="../js/html5shiv.min.js"></script>
    <![endif]-->
      <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/highlight.min.js"></script>
      <script>hljs.highlightAll();</script> 
</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side stickynav">
    <div class="wy-side-scroll">
      <div class="wy-side-nav-search">
          <a href="..">
          <img src="../img/favicon-96x96.png" class="logo" alt="Logo"/>
        </a><div role="search">
  <form id ="rtd-search-form" class="wy-form" action="../search.html" method="get">
      <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" title="Type search term here" />
  </form>
</div>
      </div>

      <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="..">Mosaic Introduction</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../status/">Status and Development</a>
                </li>
              </ul>
              <ul class="current">
                <li class="toctree-l1 current"><a class="reference internal current" href="#">Rationale</a>
                </li>
              </ul>
              <p class="caption"><span class="caption-text">Mosaic Core</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" >Identity</a>
    <ul>
                <li class="toctree-l2"><a class="reference internal" href="../cryptography/">Cryptography</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../identity/">Identity</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../bootstrap/">Bootstrap</a>
                </li>
    </ul>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" >Record Type</a>
    <ul>
                <li class="toctree-l2"><a class="reference internal" href="../timestamps/">Timestamps</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../record/">Record Format</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../human_readable_content/">Human Readable Content</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../core_tags/">Core Tags</a>
                </li>
    </ul>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../reference/">References</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" >Core Records</a>
    <ul>
                <li class="toctree-l2"><a class="reference internal" href="../keyschedule/">Key Schedule Record</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../profile/">Profile Record</a>
                </li>
    </ul>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" >Protocol</a>
    <ul>
                <li class="toctree-l2"><a class="reference internal" href="../filter/">Filter</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../protocol/">Core Protocol</a>
                </li>
    </ul>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" >Registries</a>
    <ul>
                <li class="toctree-l2"><a class="reference internal" href="../tag_types/">Tag Type Registry</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../kinds/">Record Kind Registry</a>
                </li>
    </ul>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">Mosaic Accessory</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../human_encodings/">Human Encodings</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">Mosaic Transport</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../websockets/">WebSockets</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../webtransport/">WebTransport</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">Extensions</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../sync_protocol_extension/">Sync Protocol Extension</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">Applications</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" >Mosaic Social media</a>
    <ul>
                <li class="toctree-l2"><a class="reference internal" href="../microblog/">Microblogging</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../blog/">Blog</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../reply_comment/">Reply Comment</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../chat/">Chat</a>
                </li>
    </ul>
                  </li>
              </ul>
      </div>
    </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">
      <nav class="wy-nav-top" role="navigation" aria-label="Mobile navigation menu">
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="..">Mosaic</a>
        
      </nav>
      <div class="wy-nav-content">
        <div class="rst-content"><div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href=".." class="icon icon-home" aria-label="Docs"></a></li>
      <li class="breadcrumb-item active">Rationale</li>
    <li class="wy-breadcrumbs-aside">
    </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
            <div class="section" itemprop="articleBody">
              
                <h1 id="rationale">Rationale</h1>
<p>For brevity, the rationale for various decisions has been elided from its context and linked
to this page with <a href="#"><sup>rat</sup></a> links.</p>
<table>
<thead>
<tr>
<th>Contents</th>
</tr>
</thead>
<tbody>
<tr>
<td><a href="#binary-records">Binary Records</a></td>
</tr>
<tr>
<td><a href="#blake3">BLAKE3</a></td>
</tr>
<tr>
<td><a href="#client-server">Client-Server</a></td>
</tr>
<tr>
<td><a href="#distributed">Distributed</a></td>
</tr>
<tr>
<td><a href="#duplex-communication">Duplex Communication</a></td>
</tr>
<tr>
<td><a href="#eddsa-ed25519">EdDSA ed25519</a></td>
</tr>
<tr>
<td><a href="#mainline-dht">Mainline DHT</a></td>
</tr>
<tr>
<td><a href="#master-key-subkey">Master-Key Subkey</a></td>
</tr>
<tr>
<td><a href="#no-ip-privacy">No IP Privacy</a></td>
</tr>
<tr>
<td><a href="#records">Records</a></td>
</tr>
<tr>
<td><a href="#references">References</a></td>
</tr>
<tr>
<td><a href="#server-identities">Server Identities</a></td>
</tr>
<tr>
<td><a href="#sovereign">Sovereign</a></td>
</tr>
<tr>
<td><a href="#storing-received-at-timestamps">Storing received-at timestamps</a></td>
</tr>
<tr>
<td><a href="#timestamps">Timestamps</a></td>
</tr>
<tr>
<td><a href="#tls">TLS</a></td>
</tr>
</tbody>
</table>
<hr />
<h2 id="binary-records">Binary Records</h2>
<p>The record structure could be JSON, CBOR (or BEVE or similar) or Binary.</p>
<table>
<thead>
<tr>
<th>Encoding</th>
<th>Human Readable</th>
<th>Extensible</th>
<th>Parse Speed</th>
<th>Copy to Sign</th>
<th>Size</th>
</tr>
</thead>
<tbody>
<tr>
<td>JSON</td>
<td><strong>yes</strong></td>
<td><strong>yes</strong></td>
<td>slow</td>
<td>copy</td>
<td>largest</td>
</tr>
<tr>
<td>CBOR</td>
<td>no</td>
<td><strong>yes</strong></td>
<td><strong>fast</strong></td>
<td>Maybe</td>
<td><strong>medium</strong></td>
</tr>
<tr>
<td>Binary</td>
<td>no</td>
<td>no</td>
<td><strong>NONE</strong></td>
<td><strong>NO</strong></td>
<td><strong>SMALLEST</strong></td>
</tr>
</tbody>
</table>
<p>Except for human readability, CBOR is better than JSON in cases where extensibility
is needed.</p>
<p>Other than that, binary is better in all respects.</p>
<p>We argue that extensibility of the main record is sufficiently done via record kinds,
tags and content, and therefore extensibility is not needed for this structure.</p>
<p>We sacrifice:</p>
<ul>
<li>Human readability</li>
<li>Extensibility</li>
</ul>
<p>We gain:</p>
<ul>
<li>Zero parsing required</li>
<li>Zero copying for signing required</li>
<li>Smallest size has been achieved</li>
</ul>
<p>BTW: JSON also has character encoding ambiguities.</p>
<hr />
<h2 id="blake3">BLAKE3</h2>
<p>This is a very fast hash function with 128-bit security. It is even sometimes faster in
software than hardware versions of SHA-256, and s about 14x as fast as software versions
of SHA-256. It is highly parallelizable and can take advantage of vector instructions.</p>
<p>It's predecessor BLAKE was the most analyzed algorithm during the NIST SHA-3 competition.</p>
<p>EdDSA ed25519 is defined to use SHA-512 and we are using BLAKE3 as a drop-in replacement, so
we have to produce 512-bit hashes. But these   do not need to be in the record. What the
record needs is some way to index and reference it, and part of the hash (at least 256 bits)
is good enough for that purpose.</p>
<p>In BLAKE3, hashes are variable size, and smaller outputs are prefixes of longer outputs.
We utilize this.</p>
<hr />
<h2 id="client-server">Client-Server</h2>
<p>Mosaic is NOT peer-to-peer. It turns out that peer-to-peer is difficult because most computers are not
fully connected to the Internet. And as there is nothing particular difficult in running a server that
<em>is</em> fully connected to the Internet (given VPS availability), being strictly peer-to-peer doesn't seem
advantageous. So we choose the more rock-solid client-server architecture.</p>
<p>However, we opt for a dumb-server smart-client design to put more control into the hands of the users.</p>
<hr />
<h2 id="distributed">Distributed</h2>
<p>Centralized systems have a fatal flaw: they can easily be captured and controlled by people you do not
agree with such as corporate or government censors or hackers. By having a
central point of attack, the entire
system can be taken down or damaged by bad actors.</p>
<p>Mosaic is desgined to be fully distributed, with no centralized points of failure.</p>
<p>There is no central place to bootstrap Mosaic either. We use Mainline DHT's bootstrapping, there are
mutiple bootstrap servers and you can run your own.</p>
<hr />
<h2 id="duplex-communication">Duplex Communication</h2>
<p>We base Mosaic on transport protocols that provide duplex communication such as Web Sockets and
Web Transport.  This is in opposition to a request-response architecture such as HTTP REST.</p>
<p>This allows either side to initiate an action, which turns out to be a very useful feature.
For example when a new record that matches a user's subscribed filters arrives at the server,
the server can immediately shuttle it to the client. In a request-response architecture, there
would be a delay until the client polled again. And due to the polling nature, the client would
need to make many poll requests even when nothing was ready for them.</p>
<hr />
<h2 id="eddsa-ed25519">EdDSA ed25519</h2>
<p>We chose this elliptic curve because it is the state of the art.</p>
<ul>
<li>It is fast</li>
<li>It is space efficient</li>
<li>It is widely studied</li>
<li>It has very good resistance to side-channel attacks</li>
<li>It does not require point validation</li>
<li>It interoperates with ssh, gpg, TLS, Mainline DHT, and other modern ed25519-based
  identity systems</li>
</ul>
<p>We replaced the hashing algorithm because multiple good cryptographers have indicated that any
secure hashing algorithm that produces hashes of the right size could be used, and we chose
<a href="#blake3">BLAKE3</a>.</p>
<p>We provide a context string so that users cannot be tricked by one application into signing
content for a different application (in case users think they can use the same keypair for
every application).</p>
<p>We added additional checks in order to provide the following guarantees:</p>
<ul>
<li>Existentially and Strongly unforgeable under chosen message attacks</li>
<li>Strongly Binding Signature</li>
</ul>
<p>See <a href="https://eprint.iacr.org/2020/1244.pdf">Taming the many EdDSAs</a></p>
<p>See <a href="https://eprint.iacr.org/2020/823.pdf">The Provable Security of Ed25519: Theory and Practice</a></p>
<hr />
<h2 id="mainline-dht">Mainline DHT</h2>
<p>Mainline DHT is distributed and censorship resistant, including being resistant to (or able
to detect) Sybil attacks. It is the largest (or one of) and longest living DHT.</p>
<p>It also has this mutable data functionality and works with ed25519 signed data.</p>
<h3 id="salt">Salt</h3>
<p>We use the salt to avoid collisions, in case the same ed25519 identity keypair is used by
both mosaic and <a href="https://github.com/pubky">pubky</a>, or in case we need to change the format
of the bootstrap in the future.</p>
<p>We also need different salts because we have two different kinds of bootstraps already.
Different salts allow a server keypair to also be a user keypair without collision.</p>
<p>These salts are short enough to not use too much space.</p>
<h3 id="sequence-numbers">Sequence Numbers</h3>
<p>We don't need collision protection here because writing this record requires the secure
master key which is likely to be in only one place, and even if copied around we still
do not expect people to write often from multiple places.</p>
<p>We could change to timestamps instead if this becomes a problem and still remain backwards
compatible.</p>
<hr />
<h2 id="master-key-subkey">Master-Key Subkey</h2>
<p>Users need to keep their secret key secure so they don't have their identity stolen. But
they also need to access their secret key online in order to use the protocol. By splitting
the keys into a master key and multiple device keys (or subkeys) we can enable very secure
master key storage and usage without impeding the ability to operate online with subkeys.</p>
<hr />
<h2 id="no-ip-privacy">No IP Privacy</h2>
<p>Several IP privacy network layers exist which already do a good job (Tor, i2p, VPNs). The IP privacy
issue is almost entirely orthogonal to the application protocol, and so architecturally it makes sense
to separate application layers from privacy layers. There is no good reason to reinvent another privacy
layer just for Mosaic since Mosaic can run on top of an already existing general-purpose privacy layer.</p>
<hr />
<h2 id="records">Records</h2>
<h3 id="maximum-size">Maximum Size</h3>
<p>This is specified so that length fields inside of records can be of a defined fixed number
of bits and so that software can make reasonable decisions about buffer sizes.</p>
<h3 id="layout">Layout</h3>
<p>Record layout provides a compromise between being tightly packed and providing 64-bit
alignment of fields.</p>
<p>All data that needs hashing is contigous so that no data needs to be copied in order to produce
the hash. The hash-based id and signature could have appeared before or after, and we have chosen
to place them before to give them well defined offsets.</p>
<h3 id="flags">Flags</h3>
<p>A number of record properties that span applications have been conceived of and we
provided space to set these.</p>
<p>We provided separate flags for application-specific usage. These are quicker to look
up than tag-based or content-based flags.</p>
<h3 id="multiple-timestamps">Multiple Timestamps</h3>
<p>At first blush it appears we have the timestamp three different times. But consider this:</p>
<p>The only timestamp that is current and hashed (and signed) is the <a href="../record/#timestamp">timestamp</a>
field. So we cannot dispense with that.</p>
<p>The big-endian original timestamp in the address is required for sorting and
differentiation, and it is also hashed and signed (but not necessarily the creation
time of the record).</p>
<p>And the big-endian timestamp in the ID is not hashed or signed.</p>
<h3 id="tags">Tags</h3>
<p>Tag values should not be too large as they need to be indexed by relays.</p>
<p>Constraining the value to 253 bytes allows an entire TLV (with 16-bit type and 8-bit length) to
fit within 256 bytes.</p>
<p>While for some tag types a length could be inferred, this is not true in general. Applications
should not be required to recognize every tag type to look up its known length or type-specific
method of length calculation.</p>
<p>Some tag types start with padding in the value in order to better align
their data.</p>
<hr />
<h2 id="references">References</h2>
<h3 id="id-fields">Id Fields</h3>
<p>The hash in the ID cryptographically represents all the data that was hashed.
It is 40 bytes long because we needed at least 32 bytes for cryptographic
reasons, and because addresses are already 48 bytes long, we used the extra
8 bytes to extend the hash.</p>
<p>The entire 512-bit (64 byte) hash is overkill. Even though we have to produce
it for the EdDSA ed25519 signature, we don't have to waste precious record
space with that entire long hash.</p>
<p>By putting the big-endian timestamp at the front of the ID, IDs sort in time
order and group temporally (for database performance).</p>
<p>The zeroes in the ID maintain 64-bit alignment.</p>
<h3 id="address-fields">Address Fields</h3>
<p>By not including the hash of content, records can be edited and replaced by
the author (where edits make sense). Application will specify which kind of
reference to use in which context.</p>
<p>By containing the Author public key, record location can be determined
through <a href="../bootstrap/">bootstrapping</a>.</p>
<p>By containing the kind, records that are edited cannot change their kind.</p>
<p>By containing the kind, software can filter records that are not relevant to
a situation without needing to look them up first.</p>
<p>By putting the timestamp at the front of the address in big-endian format,
addresses sort in time order and group temporally (for database performance).</p>
<p>By containing the original timestamp and a 64-bit nonce, it is statistically
infeasible for two different records to have the same address unintentionally.
In fact this is overkill, but using anything shorter that still aligns at
64-bits ends up being not unique enough.</p>
<p>At only 48 bytes long, these can easily fit into a 253 byte tag when needed.</p>
<p>By the first bit being a 1, IDs and ADDRs can be intermixed and their type
determined by that bit.</p>
<p>--</p>
<h2 id="server-identities">Server Identities</h2>
<p>By recognizing a server by it's key, we can verify server identity directly.</p>
<ul>
<li>We no longer need to trust DNS, that it gave us the right IP address</li>
<li>We no longer need to trust Certification Authorities, that the DNS to IP address binding
  is correct.</li>
</ul>
<p>Additionally, servers can now present themselves at multiple transport endpoints.</p>
<p>By having a strong form of identification, clients can maintain reliable reputational
information about servers.</p>
<hr />
<h2 id="sovereign">Sovereign</h2>
<p>Ethically, we believe in free speech and empowering individuals.</p>
<p>All participation is self-managed and nobody can cancel your account. You manage your own keys.</p>
<p>This allows users to be independent of any service provider and to change the servers they use at
any time.</p>
<p>Mosaic does not depend on upstream DNS providers and Mosaic does not depend on Certification Authorities
to issue certificates.</p>
<p>We use a dumb-server smart-client model in order to push as much control into the user's realm (the client
space) as feasible.</p>
<hr />
<h2 id="storing-received-at-timestamps">Storing received-at timestamps</h2>
<p>We require clients and servers to store this information for two reasons.</p>
<p>The first and most important is for key revocation. Revocation can't be applied to only
records in the past judged by timestamps in the records themselves because those
timestamps can be forged. By remembering when a record was received, an upper time
bound is established, and records prior to that bound can continue to be trusted while
records after that bound can be invalidated.</p>
<p>Secondly, when synchronizing with a relay, clients want to ask for records they
have not gotten yet. They can use this received-at data to avoid missing events
that were timestamped earlier but arrived later than the last time they checked for
events.</p>
<hr />
<h2 id="timestamps">Timestamps</h2>
<h3 id="leap-seconds">Leap Seconds</h3>
<p>UTC is a discontinous time scale that is occasionally adjusted by leap seconds.
Unixtime is derived from UTC and is thus also discontinuous.  Subtracting two
unixtimes could give a time interval that is off by up to 28 seconds (for
example when comparing dates before 1 Jan 1972 with today).</p>
<p>The first bit is zero in case it is ever interpreted as a sign bit, in order
to preserve sorting.</p>
<h3 id="milliseconds">Milliseconds</h3>
<p>Millisecond unixtimes only take 6 bytes and in 47 bits give us more than
4000 years before they roll over.</p>
<h3 id="bit-48">Bit 48</h3>
<p>The most significant bit of timestamps is set to 0 in case software interprets
it as a signed integer, to preserve sorting.</p>
<hr />
<h2 id="tls">TLS</h2>
<p>We use TLS security because it is heavily researched and state-of-the-art.</p>
<p>But we don't use the X.509 certificates as intended since both client and server are known by
their public keys, not by DNS names.  Instead we use RawPublicKey or self-signed certificates.</p>
<p>Clients are authenticated via client-side certificates.</p>
              
            </div>
          </div><footer>
    <div class="rst-footer-buttons" role="navigation" aria-label="Footer Navigation">
        <a href="../status/" class="btn btn-neutral float-left" title="Status and Development"><span class="icon icon-circle-arrow-left"></span> Previous</a>
        <a href="../cryptography/" class="btn btn-neutral float-right" title="Cryptography">Next <span class="icon icon-circle-arrow-right"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <!-- Copyright etc -->
  </div>

  <div>
    <i>Steve Farroll edition</i>
  </div>
</footer>
          
        </div>
      </div>

    </section>

  </div>

  <div class="rst-versions" role="note" aria-label="Versions">
  <span class="rst-current-version" data-toggle="rst-current-version">
    
    
      <span><a href="../status/" style="color: #fcfcfc">&laquo; Previous</a></span>
    
    
      <span><a href="../cryptography/" style="color: #fcfcfc">Next &raquo;</a></span>
    
  </span>
</div>
    <script src="../js/jquery-3.6.0.min.js"></script>
    <script>var base_url = "..";</script>
    <script src="../js/theme_extra.js"></script>
    <script src="../js/theme.js"></script>
      <script src="../search/main.js"></script>
    <script>
        jQuery(function () {
            SphinxRtdTheme.Navigation.enable(true);
        });
    </script>

</body>
</html>
