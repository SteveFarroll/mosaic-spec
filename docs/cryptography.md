# Cryptography

<status>PAGE STATUS: early draft</status>

## Hashing

We use BLAKE3 in unkeyed hashing mode, producing a 512-bit digest.

Some of this hash (but not all of it) is also stored in the record
as part of the record Id.

Rationale:

* EdDSA ed25519 is defined to use SHA-512 and we are using BLAKE3 as a
  drop-in replacement, so we have to produce 512-bit hashes. But these
  do not need to be in the record. What the record needs is some way to
  index and reference it, and part of the hash (at least 256 bits) is
  good enough for that purpose. In BLAKE3, hashes are variable size, and
  smaller outputs are prefixes of longer outputs.
* This is a very fast hash function with 128-bit security. It is even
  sometimes faster in software than hardware versions of SHA-256, and
  is about 14x as fast as software versions of SHA-256. It is highly
  parallelizable and can take advantage of vector instructions.
* It's predecessor BLAKE was the most analyzed algorithm during the NIST
  SHA-3 competition.

## Digital Signature

We use EdDSA with the ed25519 curve and very specific public key and signature
validation checks. In particular:

* Public keys should be rejected if they are one of 8 small order points.
* Signatures must be rejected if s is not within the range 0..L-1.
* Signatures must be rejected if R or A are non-canonical
  (e.g. verify that |R| >= L and |A| >= L)
* Always use cofactor verification (8(S · B) − 8R − 8(h · A) = 0) not the
  non-cofactor one, even when not in batch mode.

Rationale:

* Fast and space efficient
* Widely studied
* Very good resistance to side-channel attacks
* Does not require point validation
* In our form, provides the following guarantees:
    * Existentially and Strongly unforgeable under chosen message attacks
    * Strongly Binding Signature
* Interoperates with ssh, gpg, TLS, Mainline DHT, and other modern ed25519-based
  identity systems

See [Taming the many EdDSAs](https://eprint.iacr.org/2020/1244.pdf)

See [The Provable Security of Ed25519: Theory and Practice](https://eprint.iacr.org/2020/823.pdf)

## Encryption

Records in Mosaic are generally not encrypted, but public things. However some
applications have a need to encrypt data.

This is a general specification of how encryption is done.

Encryption details are still TBD but we intend:

* To use ECIES
* To do the diffie-hellman between
    * an ephemeral keypair generated by the sender and used only once, and
    * one of the recipient's x25519 public keys (published in their key
      schedule), which is not ephemeral but may nonetheless be frequently
      rolled over by the recipient.

In order for a user to decrypt on any of their devices, they must share the
x25519 public key's secret to all of their devices. In order to preserve
signing security, these keys are separate from ed25519 signing keys.
See [keyschedule](keyschedule.md) marker 0x2.

See also [this page at cryptosys.net](https://www.cryptosys.net/pki/manpki/pki_eccsafecurves.html)
